# ============================================
# Transfer Aggregator Service Configuration
# ============================================

server:
  port: 8080


spring:
  application:
    name: transfer-aggregator
  
  # Enable Virtual Threads (Java 21+)
  threads:
    virtual:
      enabled: true
  
  # Jackson configuration
  jackson:
    default-property-inclusion: non_null
    deserialization:
      fail-on-unknown-properties: false
    serialization:
      write-dates-as-timestamps: false
  
  # Redis configuration for distributed caching
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 2000ms

# ============================================
# Transfer Aggregator Configuration
# ============================================
transfer:
  aggregator:
    # Mode: stub (default) or real
    mode: ${AGGREGATOR_MODE:stub}
    
    # Global timeout for all operations (search, book, cancel)
    global-timeout-seconds: 10
    
    # Supplier configurations - enable/disable suppliers here
    suppliers:
      stub:
        enabled: ${STUB_ENABLED:true}
      slow-stub:
        enabled: ${SLOW_STUB_ENABLED:true}
      mozio:
        enabled: ${MOZIO_ENABLED:true}
        base-url: ${MOZIO_BASE_URL:https://api-testing.mozio.com}
        api-key: ${MOZIO_API_KEY:}
        # Polling configuration
        poll-interval-ms: 2000
        max-poll-attempts: 5
        # Mozio Search results validity (20 minutes)
        search-validity-minutes: 20
        # HTTP timeouts
        initial-request-timeout-seconds: 10
        poll-response-timeout-seconds: 5
      skyride:
        enabled: ${SKYRIDE_ENABLED:true}
    
    # Resilience configuration
    resilience:
      # Maximum concurrent supplier calls
      max-concurrent-calls: 50
      # Rate limit per minute for search requests
      search-rate-limit-per-minute: 80
      # Rate limit per minute for poll requests per searchId
      poll-rate-limit-per-minute: 25
    
    # Multi-tenant configuration
    default-tenant: default
    tenants:
      default:
        name: "Default Tenant"
        enabled: true
        # Empty enabled-suppliers = all suppliers allowed
        
      tenant-a:
        name: "Travel Partner A"
        enabled: true
        enabled-suppliers:
          - STUB
          - MOZIO
        default-currency: USD
        max-results-per-supplier: 10
        
      tenant-b:
        name: "Travel Partner B"
        enabled: true
        enabled-suppliers:
          - SKYRIDE
          - SLOW_STUB
        default-currency: EUR
        
      tenant-premium:
        name: "Premium Partner"
        enabled: true
        enabled-suppliers:
          - STUB
          - SKYRIDE
          - MOZIO
          - SLOW_STUB
        default-currency: USD
        max-results-per-supplier: 50

# Token signing for offerId/bookingId
security:
  token:
    # HMAC-SHA256 secret key
    secret: ${TOKEN_SECRET:57fd0a434be5ba1dc468f69ee204c70328ceb8cac56d6f3e70cd39c49ce5f7d4}

# ============================================
# Resilience4j Circuit Breaker Configuration
# ============================================
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 30s
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        recordExceptions:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
          - org.springframework.web.reactive.function.client.WebClientException
    instances:
      STUB:
        baseConfig: default
      SKYRIDE:
        baseConfig: default
      SLOW_STUB:
        baseConfig: default
        waitDurationInOpenState: 60s
      MOZIO:
        baseConfig: default
        slidingWindowSize: 20
        failureRateThreshold: 40

  timelimiter:
    configs:
      default:
        timeoutDuration: 10s
        cancelRunningFuture: true

# ============================================
# Observability Configuration
# ============================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when_authorized
      probes:
        enabled: true
  metrics:
    tags:
      application: transfer-aggregator
    distribution:
      percentiles-histogram:
        http.server.requests: true

# ============================================
# Logging Configuration
# ============================================
logging:
  level:
    root: INFO
    com.arcube.transferaggregator: DEBUG
    org.springframework.web: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{requestId:-}] %logger{36} - %msg%n"

# ============================================
# OpenAPI/Swagger Configuration
# ============================================
springdoc:
  api-docs:
    path: /api-docs
  swagger-ui:
    path: /swagger-ui.html
    operations-sorter: method
    tags-sorter: alpha
    url: /openapi.yaml
